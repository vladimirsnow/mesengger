<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä max</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h2>–û–Ω–ª–∞–π–Ω –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>

      <!-- AUTH -->
      <div id="auth">
        <div class="row">
          <input id="email" type="email" placeholder="Email" />
          <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
          <input
            id="nickname"
            type="text"
            placeholder="–ù–∏–∫ (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)"
          />
        </div>
        <div class="controls">
          <button id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          <button id="loginBtn">–í–æ–π—Ç–∏</button>
        </div>
      </div>

      <!-- CHAT -->
      <div id="chat" style="display: none">
        <div class="row">
          <div class="small" id="welcome">–ü—Ä–∏–≤–µ—Ç</div>
          <button id="logoutBtn" style="margin-left: auto">–í—ã–π—Ç–∏</button>
        </div>

        <div id="messages"></div>

        <div class="controls" style="margin-top: 8px">
          <input
            id="messageInput"
            type="text"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            style="flex: 1"
          />
          <label
            for="fileInput"
            title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª"
            style="
              cursor: pointer;
              padding: 8px;
              border: 1px solid #ccc;
              border-radius: 6px;
            "
            >üìé</label
          >
          <button id="sendBtn" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <div id="progress"></div>
        </div>

        <!-- —Å–∫—Ä—ã—Ç—ã–π input file -->
        <input type="file" id="fileInput" />
      </div>
    </div>
    <script type="module">
      // ---------- –ö–æ–Ω—Ñ–∏–≥ Firebase ----------
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        orderBy,
        onSnapshot,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {
        getMessaging,
        getToken,
        onMessage,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBTvvpJrXsP6OY0fRov1ImbFFYXUPW1c4w",
        authDomain: "messenger-3f86f.firebaseapp.com",
        projectId: "messenger-3f86f",
        storageBucket: "messenger-3f86f.appspot.com", // –∏—Å–ø—Ä–∞–≤–∏–ª –∑–¥–µ—Å—å
        messagingSenderId: "205110361755",
        appId: "1:205110361755:web:be6c1487ac041bba7f903e",
        measurementId: "G-XFRCVYP9XK",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ----------
      const messaging = getMessaging(app);

      Notification.requestPermission().then((permission) => {
        if (permission === "granted") {
          getToken(messaging, {
            vapidKey:
              "BI8xaSfZhsr-ZIi3OLSz0rRmSRipKjZQ_Bm9nPANIW4Jw2orbN2Ee3iC9wIQhPoO0a2U9laIKU2AayKV-hy3JYg",
          }).then((currentToken) => {
            if (currentToken) {
              console.log("Push —Ç–æ–∫–µ–Ω:", currentToken);
              // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ Firestore –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            } else {
              console.log("–¢–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω");
            }
          });
        }
      });

      onMessage(messaging, (payload) => {
        console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ:", payload);
        new Notification(payload.notification.title, {
          body: payload.notification.body,
          icon: payload.notification.icon,
        });
      });

      // ---------- –ö–æ–Ω—Ñ–∏–≥ Cloudinary ----------
      const cloudName = "du5qgenm4"; // —Ç–≤–æ–π Cloud Name
      const uploadPreset = "messenger_upload"; // —Ç–≤–æ–π unsigned preset

      // ---------- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ----------
      const authDiv = document.getElementById("auth");
      const chatDiv = document.getElementById("chat");
      const emailIn = document.getElementById("email");
      const passIn = document.getElementById("password");
      const nickIn = document.getElementById("nickname");
      const registerBtn = document.getElementById("registerBtn");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const welcome = document.getElementById("welcome");

      const messagesDiv = document.getElementById("messages");
      const msgInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const fileInput = document.getElementById("fileInput");
      const progressText = document.getElementById("progress");

      let currentNick = "";
      let currentUid = null;
      let pendingFile = null; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª

      // ---------- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ----------
      registerBtn.addEventListener("click", async () => {
        const email = emailIn.value.trim();
        const password = passIn.value;
        const nickname = nickIn.value.trim();
        if (!email || !password || !nickname)
          return alert("–ó–∞–ø–æ–ª–Ω–∏ email, –ø–∞—Ä–æ–ª—å –∏ –Ω–∏–∫.");

        try {
          const cred = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const uid = cred.user.uid;
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∏–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
          await setDoc(doc(db, "users", uid), { nickname, email });
          alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏.");
        } catch (e) {
          alert(e.message);
        }
      });

      // ---------- –í—Ö–æ–¥ ----------
      loginBtn.addEventListener("click", async () => {
        const email = emailIn.value.trim();
        const password = passIn.value;
        if (!email || !password) return alert("–ó–∞–ø–æ–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª—å.");
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (e) {
          alert(e.message);
        }
      });

      // ---------- –í—ã—Ö–æ–¥ ----------
      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
      });

      // ---------- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ----------
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUid = user.uid;
          // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫
          const udoc = await getDoc(doc(db, "users", user.uid));
          currentNick = udoc.exists()
            ? udoc.data().nickname || user.email
            : user.email;
          welcome.innerText = "–ü—Ä–∏–≤–µ—Ç, " + currentNick;
          authDiv.style.display = "none";
          chatDiv.style.display = "block";
          startMessagesListener();
        } else {
          currentNick = "";
          currentUid = null;
          authDiv.style.display = "block";
          chatDiv.style.display = "none";
          messagesDiv.innerHTML = "";
          stopMessagesListener();
        }
      });

      // ---------- –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π ----------
      let unsubscribe = null;
      function startMessagesListener() {
        const q = query(
          collection(db, "messages"),
          orderBy("timestamp", "asc")
        );
        unsubscribe = onSnapshot(q, (snap) => {
          messagesDiv.innerHTML = "";
          snap.forEach((docSnap) => {
            const m = docSnap.data();
            renderMessage(m);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
      }
      function stopMessagesListener() {
        if (unsubscribe) {
          unsubscribe();
          unsubscribe = null;
        }
      }

      // ---------- –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è ----------
      function renderMessage(msg) {
        const el = document.createElement("div");
        el.className = "msg";
        const meta = document.createElement("div");
        meta.className = "meta";
        const timeStr =
          msg.timestamp && msg.timestamp.toDate
            ? new Date(msg.timestamp.toDate()).toLocaleString()
            : "";
        meta.textContent =
          (msg.sender || "Anon") + (timeStr ? " ‚Ä¢ " + timeStr : "");
        el.appendChild(meta);

        if (msg.fileUrl) {
          const url = msg.fileUrl;
          const type = msg.fileType || "";
          // image
          if (
            type.startsWith("image/") ||
            url.match(/\.(jpe?g|png|gif|webp)(\?|$)/i)
          ) {
            const i = document.createElement("img");
            i.src = url;
            i.alt = msg.fileName || "image";
            el.appendChild(i);
          }
          // video
          else if (
            type.startsWith("video/") ||
            url.match(/\.(mp4|webm|ogg)(\?|$)/i)
          ) {
            const v = document.createElement("video");
            v.controls = true;
            v.src = url;
            el.appendChild(v);
          }
          // others
          else {
            const a = document.createElement("a");
            a.href = url;
            a.target = "_blank";
            a.textContent = "üìé " + (msg.fileName || "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª");
            el.appendChild(a);
          }
          // optional text under file
          if (msg.text) {
            const t = document.createElement("div");
            t.className = "small";
            t.textContent = msg.text;
            el.appendChild(t);
          }
        } else {
          const p = document.createElement("div");
          p.textContent = msg.text || "";
          el.appendChild(p);
        }

        messagesDiv.appendChild(el);
      }

      // ---------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ----------
      fileInput.addEventListener("change", (e) => {
        pendingFile = e.target.files[0] || null;
        if (pendingFile) {
          progressText.innerText = "–§–∞–π–ª –≤—ã–±—Ä–∞–Ω: " + pendingFile.name;
        } else {
          progressText.innerText = "";
        }
      });

      // ---------- –û—Ç–ø—Ä–∞–≤–∫–∞ (—Ç–µ–∫—Å—Ç + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–∞–π–ª) ----------
      sendBtn.addEventListener("click", async () => {
        const text = msgInput.value.trim();
        // –µ—Å–ª–∏ —Ñ–∞–π–ª –µ—Å—Ç—å ‚Äî —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ Cloudinary
        try {
          let fileUrl = null;
          let fileType = null;
          let fileName = null;

          if (pendingFile) {
            progressText.innerText = "–ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª...";
            const fd = new FormData();
            fd.append("file", pendingFile);
            fd.append("upload_preset", uploadPreset);

            const res = await fetch(
              `https://api.cloudinary.com/v1_1/${cloudName}/upload`,
              {
                method: "POST",
                body: fd,
              }
            );

            if (!res.ok) {
              const errText = await res.text();
              throw new Error("Cloudinary upload failed: " + errText);
            }

            const data = await res.json();
            fileUrl = data.secure_url;
            // file type –ª—É—á—à–µ –±—Ä–∞—Ç—å –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            fileType =
              pendingFile.type ||
              (data.resource_type === "image" ? "image/*" : "");
            fileName =
              pendingFile.name || (data.public_id || "").split("/").pop();

            progressText.innerText = "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω";
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
          await addDoc(collection(db, "messages"), {
            text: text || "",
            sender: currentNick || "Anon",
            fileUrl: fileUrl || null,
            fileType: fileType || null,
            fileName: fileName || null,
            timestamp: serverTimestamp(),
          });

          // –æ—á–∏—Å—Ç–∫–∞
          msgInput.value = "";
          fileInput.value = "";
          pendingFile = null;
          progressText.innerText = "";
        } catch (err) {
          alert("–û—à–∏–±–∫–∞: " + err.message);
          progressText.innerText = "";
        }
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/firebase-messaging-sw.js")
          .then((reg) => {
            console.log("Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", reg);
          })
          .catch((err) => {
            console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:", err);
          });
      }

      // ---------- –ö–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞ ----------
    </script>
  </body>
</html>
